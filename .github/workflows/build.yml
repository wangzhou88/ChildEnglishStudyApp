name: Android CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'app/**'
      - 'build.gradle'
      - 'settings.gradle'
      - 'gradle.properties'
      - '.github/workflows/**'
  pull_request:
    branches: [ main, develop ]
  release:
    types: [published]

env:
  JAVA_VERSION: '17'
  ANDROID_TARGET_SDK: '34'
  ANDROID_BUILD_TOOLS_VERSION: '34.0.0'

jobs:
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: è¿è¡Œktlintä»£ç æ ¼å¼æ£€æŸ¥
        run: |
          curl -sSLO https://github.com/pinterest/ktlint/releases/latest/download/ktlint
          chmod a+x ktlint
          ./ktlint --reporter=plain app/src/main/java/**/*.kt
        continue-on-error: true

      - name: è¿è¡ŒDetekté™æ€ä»£ç åˆ†æ
        run: |
          curl -sSLO https://github.com/detekt/detekt/releases/latest/download/detekt
          chmod a+x detekt
          ./detekt -i app/src/main/java
        continue-on-error: true

      - name: ä¸Šä¼ ä»£ç è´¨é‡æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-quality-reports
          path: |
            ktlint-report.txt
            detekt-report.txt
          retention-days: 7

  dependency-scan:
    name: ä¾èµ–å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è¿è¡ŒOWASPä¾èµ–æ£€æŸ¥
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'ChildEnglishStudyApp'
          path: '.'
          format: 'ALL'
          args: >
            --enableExperimental

      - name: ä¸Šä¼ ä¾èµ–æ‰«ææŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-scan-reports
          path: reports/
          retention-days: 30

  test:
    name: è‡ªåŠ¨åŒ–æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [code-quality]
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: è®¾ç½®Android SDK
        uses: android-actions/setup-android@v2

      - name: ç¼“å­˜Gradleä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: æˆæƒGradleæ‰§è¡Œ
        run: chmod +x gradlew

      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: ./gradlew test

      - name: è¿è¡ŒInstrumentationæµ‹è¯•
        run: ./gradlew connectedAndroidTest
        continue-on-error: true

      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            app/build/reports/tests/
            app/build/reports/androidTests/
          retention-days: 7

  build:
    name: æ„å»ºAPK
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: è®¾ç½®Android SDK
        uses: android-actions/setup-android@v2

      - name: ç¼“å­˜Gradleä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: æˆæƒGradleæ‰§è¡Œ
        run: chmod +x gradlew

      - name: æ„å»ºDebug APK
        run: ./gradlew assembleDebug

      - name: æ„å»ºRelease APK
        run: ./gradlew assembleRelease
        continue-on-error: true

      - name: ä¸Šä¼ Debug APK
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7

      - name: ä¸Šä¼ Release APK
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: app-release
          path: app/build/outputs/apk/release/app-release.apk
          retention-days: 7

  version-manager:
    name: ç‰ˆæœ¬ç®¡ç†
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_code: ${{ steps.version.outputs.version_code }}
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è‡ªåŠ¨é€’å¢ç‰ˆæœ¬å·
        id: version
        run: |
          CURRENT_VERSION=$(grep versionName app/build.gradle | sed 's/.*"\(.*\)".*/\1/')
          VERSION_CODE=$(( $(grep versionCode app/build.gradle | sed 's/.*"\(.*\)".*/\1/') + 1 ))
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "æ–°ç‰ˆæœ¬: $CURRENT_VERSION (ç‰ˆæœ¬ä»£ç : $VERSION_CODE)"

      - name: æ›´æ–°ç‰ˆæœ¬å·
        run: |
          sed -i "s/versionCode .*/versionCode ${{ steps.version.outputs.version_code }}/" app/build.gradle
          echo "ç‰ˆæœ¬å·å·²æ›´æ–°"

      - name: æäº¤ç‰ˆæœ¬æ›´æ–°
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add app/build.gradle
          git commit -m "chore: è‡ªåŠ¨é€’å¢ç‰ˆæœ¬å·è‡³ ${{ steps.version.outputs.version }}" || echo "ç‰ˆæœ¬å·æ— éœ€æ›´æ–°"
          git push || echo "æ¨é€å¤±è´¥ï¼Œä½†æ„å»ºç»§ç»­"

  create-release:
    name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
    runs-on: ubuntu-latest
    needs: [build, version-manager]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: ä¸‹è½½APKæ–‡ä»¶
        uses: actions/download-artifact@v4
        with:
          name: app-release
          path: ./release

      - name: åˆ›å»ºGitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.version-manager.outputs.version }}
          name: å‘å¸ƒç‰ˆæœ¬ ${{ needs.version-manager.outputs.version }}
          body: |
            ğŸ‰ å„¿ç«¥è‹±è¯­å­¦ä¹ åº”ç”¨æ–°ç‰ˆæœ¬å‘å¸ƒï¼

            ## ç‰ˆæœ¬ä¿¡æ¯
            - **ç‰ˆæœ¬å·**: ${{ needs.version-manager.outputs.version }}
            - **ç‰ˆæœ¬ä»£ç **: ${{ needs.version-manager.outputs.version_code }}
            - **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}

            ## ä¸»è¦æ”¹è¿›
            - âœ… å®Œæ•´çš„CI/CDè‡ªåŠ¨åŒ–æµç¨‹
            - âœ… ä»£ç è´¨é‡æ£€æŸ¥å’Œé™æ€åˆ†æ
            - âœ… è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–
            - âœ… ä¾èµ–å®‰å…¨æ‰«æ
            - âœ… è‡ªåŠ¨ç‰ˆæœ¬ç®¡ç†

            ## ä¸‹è½½è¯´æ˜
            è¯·ä¸‹è½½ä¸‹é¢çš„release APKæ–‡ä»¶è¿›è¡Œæµ‹è¯•å’Œå‘å¸ƒã€‚
          files: |
            ./release/*.apk
          draft: false
          prerelease: false

  notify:
    name: æ„å»ºçŠ¶æ€é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [code-quality, dependency-scan, test, build, version-manager]
    if: always()
    steps:
      - name: å‘é€æ„å»ºçŠ¶æ€é€šçŸ¥
        run: |
          if [ "${{ needs.code-quality.result }}" == "success" ] && \
             [ "${{ needs.dependency-scan.result }}" == "success" ] && \
             [ "${{ needs.test.result }}" == "success" ] && \
             [ "${{ needs.build.result }}" == "success" ]; then
            echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼æ„å»ºæˆåŠŸ"
          else
            echo "âŒ æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹æ­¥éª¤:"
            [ "${{ needs.code-quality.result }}" != "success" ] && echo "- ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥"
            [ "${{ needs.dependency-scan.result }}" != "success" ] && echo "- ä¾èµ–å®‰å…¨æ‰«æå¤±è´¥"
            [ "${{ needs.test.result }}" != "success" ] && echo "- è‡ªåŠ¨åŒ–æµ‹è¯•å¤±è´¥"
            [ "${{ needs.build.result }}" != "success" ] && echo "- APKæ„å»ºå¤±è´¥"
          fi